{% extends 'layout/main/main_base.html' %}
{% load static %}

{% block title %}Q&A{% endblock title %}

{% block header %}
    {% include 'layout/main/main_header.html' %}
{% endblock header %}

{% block content %}
    <div class="qna-detail-container my-3">
        <!-- ì§ˆë¬¸ -->
        <h1 class="display-6 border-bottom py-2">Q{{ qna.qna_id }}. {{ qna.title }}</h1>
        <div class="qna-detail-card mt-3">
            <div class="qna-detail-card-body">
                <div class="qna-detail-card-text">{{ qna.content }}</div>
                <div class="d-flex justify-content-end">
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div class="mb-2">{{ qna.member_id }}</div>
                        <div class="mb-2">{{ qna.created_at }}</div>
                        {# í¸ì§‘ëœ ê²½ìš°ë§Œ ì¶œë ¥ #}
                        {% if qna.created_at < qna.updated_at %}
                            <div>{{ qna.updated_at }}(í¸ì§‘ë¨)</div>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    {# ì§ˆë¬¸ ìˆ˜ì •/ì‚­ì œ #}
                    <div class="my-3">
                        {# ì§ˆë¬¸ ì¶”ì²œ #}
    {#                    <a href="javascript:void(0)"#}
    {#                       data-uri="{% url 'qna:question_vote' question.id  %}"#}
    {#                       class="recommend btn btn-sm btn-outline-secondary"> ì¶”ì²œ#}
    {#                        <span class="badge rounded-pill bg-success">{{question.voter.count}}</span>#}
    {#                    </a>#}
                        {# ì‘ì„±ì ë³¸ì¸ì—ê²Œë§Œ ë²„íŠ¼ ë…¸ì¶œ #}
{#                        {% if qna.member_id == member.member_id %}#}
                        {% if qna.member_id == request.user.member.member_id %}
                            <a href="{% url 'qna:qna_modify' qna.qna_id %}" class="btn btn-sm btn-outline-secondary">ìˆ˜ì •</a>
                            <a href="javascript:void(0)" data-uri="{% url 'qna:qna_delete' qna.qna_id %}" class="remove btn btn-sm btn-outline-danger">ì‚­ì œ</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- ë‹µë³€ ëª©ë¡ ì‹œì‘ -->
        {% for answer in answers %}
            <div id="answer_{{ answer.id }}" class="qna-detail-card my-3">
                <div class="qna-detail-card-body">
                    <span class="badge text-bg-secondary" style="margin-right: 95%">{{ forloop.counter }}</span>
                    <div class="qna-detail-card-text">
                        {{ answer.content }}
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="badge bg-light text-dark p-2 text-start">
                            <div class="mb-2">{{ answer.author_id }}</div>
                            <div class="mb-2">{{ answer.created_at }}</div>
                            {# í¸ì§‘ëœ ê²½ìš°ë§Œ ì¶œë ¥ #}
                            {% if answer.created_at < answer.updated_at %}
                                <div>{{ answer.updated_at }}(í¸ì§‘ë¨)</div>
                            {% endif %}
                        </div>
                    </div>
                    {# ë‹µë³€ ìˆ˜ì •/ì‚­ì œ #}
                    <div class="my-3">
                        {# ë‹µë³€ ì¶”ì²œ #}
{#                        <a href="javascript:void(0)"#}
{#                           data-uri="{% url 'qna:answer_vote' answer.id  %}"#}
{#                           class="recommend btn btn-sm btn-outline-secondary"> ì¶”ì²œ#}
{#                            <span class="badge rounded-pill bg-success">{{answer.voter.count}}</span>#}
{#                        </a>#}
                        {# ì‘ì„±ì ë³¸ì¸ì—ê²Œë§Œ ë²„íŠ¼ ë…¸ì¶œ #}
                        {% if answer.author == request.user %}
                            <a href="javascript:void(0)"
                               data-bs-toggle="modal"
                               data-bs-target="#answerModifyModal"
                               data-answer-id="{{ answer.id }}"
                               data-answer-content="{{ answer.content }}"
                               class="btn btn-sm btn-outline-secondary">ìˆ˜ì •</a>
                            <a href="javascript:void(0)"
                               data-uri="{% url 'qna:answer_delete' answer.id %}?question_id={{ qna.qna_id }}"
                               class="remove btn btn-sm btn-outline-danger">ì‚­ì œ</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
        <!-- ë‹µë³€ ëª©ë¡ ë -->

        <!-- ë‹µë³€ ë“±ë¡ ì‹œì‘ -->
        {# /qna/answer/create/2 #}
        <form name="answerCreateFrm" action="{% url 'qna:answer_create' qna.qna_id %}" method="post" class="my-3">
            <div class="mb-3">
                {# csrf ê²€ì¦ì²˜ë¦¬ : cross-site request forgery ì„œë²„ê°€ ìƒì„±í•œ ì •ìƒì ì¸ í¼í˜ì´ì§€ ê²€ì¦ #}
                {% csrf_token %}
                <label for="content" class="form-label">ë‹µë³€ë‚´ìš©</label>
                <textarea name="content" id="content" class="form-control" rows="10" required {% if user.is_anonymous %} disabled {% endif %}></textarea>
            </div>
            <div class="my-3" style="display: flex; justify-content: space-between; width: 100%;">
                <!-- ëª©ë¡ ë²„íŠ¼ ì™¼ìª½ ì •ë ¬ -->
                <a class="btn btn-primary" href="{% url 'qna:qna_main' %}" style="background-color: black; color: white;">ëª©ë¡</a>

                <!-- ë‹µë³€ ë“±ë¡ ë²„íŠ¼ ì˜¤ë¥¸ìª½ ì •ë ¬ -->
                {% if user.is_authenticated and request.session.member_type == "manager" %}
                    <input type="submit" value="ë‹µë³€ë“±ë¡" class="btn btn-primary">
                {% endif %}
            </div>

        </form>
        <!-- ë‹µë³€ ë“±ë¡ ë -->
    </div>
    <!-- ì§ˆë¬¸/ë‹µë³€ ì‚­ì œí¼ -->
    <form action="" name="questionAnswerDeleteFrm" method="post">
        {% csrf_token %}
    </form>

    <!-- Answer Modify Modal -->
    <div class="modal fade" id="answerModifyModal" tabindex="-1" aria-labelledby="answerModifyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="answerModifyModalLabel">ë‹µë³€ìˆ˜ì •</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form name="answerModifyFrm" method="post" action="">
                    {% csrf_token %}
                    <div class="modal-body">
                        <textarea name="content" id="content-modify" class="form-control" rows="10" required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}

{% block footer %}
    {% include 'layout/main/main_footer.html' %}
{% endblock footer %}



{% block script %}
    <script>
    document.answerCreateFrm.onsubmit = (e) => {
        {% if user.is_anonymous %}
            e.preventDefault(); // í¼ì œì¶œ ë°©ì§€

        	if(confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                location.href = "{% url 'main:login' %}?next={{ request.path }}"
            }
        {% endif %}
    };

    // ì§ˆë¬¸/ë‹µë³€ ì‚­ì œ ì²˜ë¦¬
    const $removeAs = document.querySelectorAll('.remove');
    console.log($removeAs); // ì—¬ëŸ¬ê±´ì˜ a.remove ìš”ì†Œë¥¼ ê°€ì§„ ë°°ì—´
    $removeAs.forEach((a_tag) => {
        a_tag.onclick = (e) => {
            // console.log(e.target.dataset)
            if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const $frm = document.questionAnswerDeleteFrm;
                $frm.action = e.target.dataset.uri;
                $frm.submit()
            }
        };
    })

    // ë‹µë³€ ìˆ˜ì •ì²˜ë¦¬
    const $answerModifyAs = document.querySelectorAll('[data-answer-id]');
    $answerModifyAs.forEach((a_tag) => {
       a_tag.onclick = (e) => {
           {#console.log(e.target.dataset.answerId); // data-answer-id -> answerId#}
           {#console.log(e.target.dataset.answerContent); // data-answer-conetent -> answerContent#}

           document.answerModifyFrm.action = `/qna/answer/modify/${e.target.dataset.answerId}/?question_id={{ question.id }}`;
           document.answerModifyFrm.querySelector('textarea#content-modify').textContent = e.target.dataset.answerContent;
       };
    });

    // ì§ˆë¬¸/ë‹µë³€ ì¶”ì²œ
    const recommend_elements = document.getElementsByClassName("recommend");
    Array.from(recommend_elements).forEach((element) => {
        // jsì˜ ë¹„ë™ê¸°ì²˜ë¦¬ë¥¼ ì§€ì›í•˜ëŠ” async..awaitì„ ì‚¬ìš©
        element.addEventListener('click', async (e) => {
            {% if not user.is_authenticated %}
                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    location.href = "{% url 'main:login' %}?next={{ request.path }}";
                }
                return false;
            {% endif %}

            console.log(e.target, e.target.dataset?.uri)
            // aíƒœê·¸ ë˜ëŠ” ìì‹spaníƒœê·¸ í´ë¦­ ëŒ€ì‘
            const url = e.target.dataset?.uri || e.target.parentElement.dataset.uri;

            // fetchëŠ” HTTP ìƒíƒœ ì½”ë“œê°€ 200ì´ ì•„ë‹ ê²½ìš°ì—ë„ ì˜ˆì™¸ê°€ ë˜ì ¸ì§€ì§€ ì•ŠëŠ”ë‹¤. ì§ì ‘ ì˜ˆì™¸ì²˜ë¦¬!
            // async..awaitì„ í†µí•œ ë™ê¸°ì  ì²˜ë¦¬ì½”ë“œ ì‘ì„±
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({'question_id': {{ qna.qna_id }}}),
            });
            const data = await response.json();
            // ì˜ˆì™¸ì²˜ë¦¬
            if (!response.ok) {
                console.error('Error:', data);
                // ë³¸ì¸ ê²Œì‹œê¸€ ì¶”ì²œí•œ ê²½ìš° ì˜¤ë¥˜ì²˜ë¦¬
                if(response.status === 400) {
                    alert(`ğŸ˜“${data.message}ğŸ˜“`);
                }
                return; // ì¡°ê¸°ë¦¬í„´
            };
            console.log(data);
            element.querySelector('span').textContent = data.votes_count;
        });
    });
    </script>
{% endblock script %}

