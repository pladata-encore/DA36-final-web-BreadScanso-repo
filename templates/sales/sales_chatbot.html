{% extends 'layout/store/base_store.html' %}
{% load static %}

{% block header %}
    {% include 'layout/store/header_store.html' %}
{% endblock header %}

{% block sidebar %}
    {% include 'layout/store/sidebar_store.html' %}
{% endblock sidebar %}

{% block title %}chatbot{% endblock title %}

{% block content %}
<div class="container">
    <p><strong>ğŸë¸Œë ˆë“œìŠ¤ìº”ì†ŒğŸ</strong> ë§¤ì¶œ&íŒë§¤ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.</p>

    <form id="chat-form">
        {% csrf_token %}
        <div id="chat-box" class="border p-3 mb-3" style="height: 350px; overflow-y: auto; background-color: whitesmoke;"></div>

        <div class="input-group mb-3">
            <input type="text" id="user-input" class="form-control" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.">
            <button class="btn btn-primary" id="send-btn">â–¶ï¸</button>
        </div>
    </form>
</div>
{% endblock content %}

{% block script %}
<script>
document.getElementById("chat-form").addEventListener("submit", function(event) {
    event.preventDefault();
    const userInput = document.getElementById("user-input").value;
    const chatBox = document.getElementById("chat-box");
    
    if (userInput.trim() === "") return;
    
    // ì‚¬ìš©ì ì§ˆë¬¸ í‘œì‹œ
    chatBox.innerHTML += `<p><strong>ğŸ§‘ ì‚¬ìš©ì:</strong> ${userInput}</p>`;
    document.getElementById("user-input").value = "";
    
    // ë¡œë”© ë©”ì‹œì§€
    const loadingId = `loading-${Date.now()}`;
    chatBox.innerHTML += `<p id="${loadingId}">ì‘ë‹µ ìƒì„± ì¤‘...</p>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    fetch("{% url 'sales:sales_chatbot' %}", {
        method: "POST",
        headers: { 
            "Content-Type": "application/json", 
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value 
        },
        body: JSON.stringify({ question: userInput })
    })
    .then(response => response.json())
    .then(data => {
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        document.getElementById(loadingId).remove();
        
        console.log("API ì‘ë‹µ:", data);
        
        if (data && data.answer) {
            // ë¹„ì¦ˆë‹ˆìŠ¤ ì–´ë“œë°”ì´ì € ì‘ë‹µ í‘œì‹œ
            chatBox.innerHTML += `<p><strong>ğŸ¤–:</strong> ${data.answer}</p>`;
        } else if (data && data.error) {
            // ì˜¤ë¥˜ ë©”ì‹œì§€
            chatBox.innerHTML += `<p><strong>âš ï¸ ì˜¤ë¥˜:</strong> ${data.error}</p>`;
        } else {
            // ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ
            chatBox.innerHTML += `<p><strong>âš ï¸ ì‹œìŠ¤í…œ:</strong> ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹ì´ ìˆ˜ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
            console.error("ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ:", data);
        }
        
        chatBox.scrollTop = chatBox.scrollHeight;
    })
    .catch(error => {
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        document.getElementById(loadingId).remove();
        
        console.error("API ìš”ì²­ ì˜¤ë¥˜:", error);
        chatBox.innerHTML += `<p><strong>âš ï¸ ì˜¤ë¥˜:</strong> ìš”ì²­ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    });
});
</script>
{% endblock %}
