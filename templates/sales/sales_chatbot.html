{% extends 'layout/store/base_store.html' %}
{% load static %}

{% block header %}
    {% include 'layout/store/header_store.html' %}
{% endblock header %}

{% block sidebar %}
    {% include 'layout/store/sidebar_store.html' %}
{% endblock sidebar %}

{% block title %}chatbot{% endblock title %}

{% block content %}
<div class="container">
    <p class="text-center" style="font-size: 17px;"><strong>ğŸë¸Œë ˆë“œìŠ¤ìº”ì†Œ</strong>ì˜ ë§¤ì¶œ&íŒë§¤ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.ğŸ</p>

    <form id="chat-form">
        {% csrf_token %}
        <div id="chat-box" class="border p-3 mb-3" style="height: 300px; overflow-y: auto; background-color: whitesmoke;"></div>

        <div class="input-group mb-3">
            <input type="text" id="user-input" class="form-control" style="height: 40px" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.">
            <button class="btn btn-info" id="send-btn">â–¶</button>
        </div>
    </form>
</div>

<style>
    .user-message {
        text-align: right;
        margin-left: 20%;
        background-color: #dcf8c6;
        padding: 6px 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        display: inline-block;
        max-width: 80%;
        float: right;
        clear: both;
        font-size: 13.5px;
    }

    .bot-message {
        text-align: left;
        margin-right: 20%;
        background-color: white;
        padding: 6px 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        display: inline-block;
        max-width: 80%;
        float: left;
        clear: both;
        font-size: 12px;
    }

    .system-message {
        text-align: center;
        font-style: italic;
        color: #777;
        margin: 8px 0;
        clear: both;
        {#font-size: 0.9em;#}
        font-size: 13.5px;
    }

    #chat-box {
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    #chat-box::after {
        content: "";
        clear: both;
        display: table;
    }

    .container {
        max-width: 800px;
    }
</style>
{% endblock content %}

{% block script %}
<script>
document.getElementById("chat-form").addEventListener("submit", function(event) {
    event.preventDefault();
    const userInput = document.getElementById("user-input").value;
    const chatBox = document.getElementById("chat-box");

    if (userInput.trim() === "") return;

    // ì‚¬ìš©ì ì§ˆë¬¸ í‘œì‹œ (ì˜¤ë¥¸ìª½ ì •ë ¬)
    chatBox.innerHTML += `<div class="user-message"><strong>ğŸ¤·ğŸ»â€â™‚ï¸ï¸:</strong> ${userInput}</div>`;
    document.getElementById("user-input").value = "";

    // ë¡œë”© ë©”ì‹œì§€
    const loadingId = `loading-${Date.now()}`;
    chatBox.innerHTML += `<div id="${loadingId}" class="system-message">ë‹µë³€ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..ğŸ•..ğŸ«§</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    fetch("{% url 'sales:sales_chatbot' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ question: userInput })
    })
    .then(response => response.json())
    .then(data => {
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        document.getElementById(loadingId).remove();

        console.log("API ì‘ë‹µ:", data);

        if (data && data.answer) {
            // ë¹„ì¦ˆë‹ˆìŠ¤ ì–´ë“œë°”ì´ì € ì‘ë‹µ í‘œì‹œ (ì™¼ìª½ ì •ë ¬)
            chatBox.innerHTML += `<div class="bot-message"><strong>ğŸ¤–:</strong> ${data.answer}</div>`;
        } else if (data && data.error) {
            // ì˜¤ë¥˜ ë©”ì‹œì§€
            chatBox.innerHTML += `<div class="system-message"><strong>âš ï¸ ì˜¤ë¥˜:</strong> ${data.error}</div>`;
        } else {
            // ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ
            chatBox.innerHTML += `<div class="system-message"><strong>âš ï¸ ì‹œìŠ¤í…œ:</strong> ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹ì´ ìˆ˜ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
            console.error("ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ:", data);
        }

        chatBox.scrollTop = chatBox.scrollHeight;
    })
    .catch(error => {
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        document.getElementById(loadingId).remove();

        console.error("API ìš”ì²­ ì˜¤ë¥˜:", error);
        chatBox.innerHTML += `<div class="system-message"><strong>âš ï¸ ì˜¤ë¥˜:</strong> ìš”ì²­ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    });
});
</script>
{% endblock %}