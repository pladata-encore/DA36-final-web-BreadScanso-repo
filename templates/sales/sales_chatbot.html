{% extends 'layout/store/base_store.html' %}
{% load static %}

{% block header %}
    {% include 'layout/store/header_store.html' %}
{% endblock header %}

{% block sidebar %}
    {% include 'layout/store/sidebar_store.html' %}
{% endblock sidebar %}

{% block title %}chatbot{% endblock title %}

{% block content %}
<div class="container">
    <p><strong>ğŸë¸Œë ˆë“œìŠ¤ìº”ì†ŒğŸ</strong> ë§¤ì¶œ&íŒë§¤ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.</p>

    <form id="chat-form">
        {% csrf_token %}
        <div id="chat-box" class="border p-3 mb-3" style="height: 350px; overflow-y: auto; background-color: whitesmoke;"></div>

        <div class="input-group mb-3">
            <input type="text" id="user-input" class="form-control" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.">
            <button class="btn btn-primary" id="send-btn">â–¶ï¸</button>
        </div>
    </form>
</div>
{% endblock content %}

{% block script %}
<script>
    // ì±—ë´‡ ì‹œì‘ ì•ˆë‚´ ë©”ì‹œì§€
    document.addEventListener('DOMContentLoaded', function() {
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = `<div class="mb-3 p-2 bg-secondary text-white rounded">
            <strong>ğŸ¤–:</strong> ë§¤ì¥ì˜ ê¸°ê°„ë³„ ì´ ë§¤ì¶œì•¡, íŒë§¤ëŸ‰ ë˜ëŠ” ì œí’ˆì˜ ê¸°ê°„ë³„ ë§¤ì¶œì•¡, íŒë§¤ëŸ‰ì„ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”.
        </div>`;
    });

    function playTTS(filePath) {
        if (!filePath || filePath === "TTS ë³€í™˜ ì‹¤íŒ¨") {
            console.error("TTS íŒŒì¼ ê²½ë¡œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", filePath);
            alert("ìŒì„± íŒŒì¼ì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        try {
            console.log("TTS ì¬ìƒ ì‹œë„:", filePath);
            const audio = new Audio(filePath);
            
            audio.addEventListener('error', function(e) {
                console.error("ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:", e);
                alert("ìŒì„± íŒŒì¼ì„ ì¬ìƒí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
            
            audio.play().catch(err => {
                console.error("ì˜¤ë””ì˜¤ ì¬ìƒ Promise ì˜¤ë¥˜:", err);
                alert("ìŒì„± íŒŒì¼ì„ ì¬ìƒí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        } catch (error) {
            console.error("TTS ì¬ìƒ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
            alert("ìŒì„± ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function sendMessage(event) {
        event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
        const userInput = document.getElementById("user-input");
        const question = userInput.value.trim();
        
        // ì‚¬ìš©ìê°€ ì…ë ¥í•˜ì§€ ì•Šì•˜ìœ¼ë©´ return
        if (!question) {
            alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML += `<div class="mb-2"><strong>ğŸ—£:</strong> ${question}</div>`;
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        userInput.value = "";

        // ë¡œë”© í‘œì‹œ
        chatBox.innerHTML += `<div id="loading" class="mb-2"><strong>ğŸ¤–:</strong> ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.ğŸ˜Š </div>`;
        
        // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ ì´ë™
        chatBox.scrollTop = chatBox.scrollHeight;

        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        const csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

        // ì„œë²„ì— ìš”ì²­
        fetch("{% url 'sales:sales_chatbot' %}", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("ì„œë²„ ì‘ë‹µ:", data);
            
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            const loadingElement = document.getElementById("loading");
            if (loadingElement) {
                loadingElement.remove();
            }
            
            if (data.answer) {
                // ì±—ë´‡ ì‘ë‹µ í‘œì‹œ
                chatBox.innerHTML += `<div class="mb-3 p-2 bg-light rounded"><strong>ğŸ¤–:</strong> ${data.answer}</div>`;
                
                // TTS ì¬ìƒ ë²„íŠ¼ ì¶”ê°€
                if (data.tts_file) {
                    console.log("TTS íŒŒì¼ ê²½ë¡œ:", data.tts_file);
                    chatBox.innerHTML += `
                        <div class="mb-3">
                            <button class="btn btn-sm btn-secondary" onclick="playTTS('${data.tts_file}')">
                                ğŸ™ï¸ ìŒì„±ìœ¼ë¡œ ë“£ê¸°
                            </button>
                        </div>`;
                }
            } else if (data.error) {
                // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                chatBox.innerHTML += `<div class="mb-2 text-danger"><strong>ì˜¤ë¥˜:</strong> ${data.error}</div>`;
            } else {
                // ê¸°íƒ€ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ ì²˜ë¦¬
                chatBox.innerHTML += `<div class="mb-2 text-warning"><strong>ì•Œë¦¼:</strong> ì„œë²„ì—ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µì´ ì™”ìŠµë‹ˆë‹¤.</div>`;
            }
            
            // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ ì´ë™
            chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(error => {
            console.error("ì„œë²„ ìš”ì²­ ì˜¤ë¥˜:", error);
            
            // ë¡œë”© ë©”ì‹œì§€ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ì œê±°
            const loadingElement = document.getElementById("loading");
            if (loadingElement) {
                loadingElement.remove();
            }
            
            chatBox.innerHTML += `<div class="mb-2 text-danger">
                <strong>ì˜¤ë¥˜:</strong> ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
                <small>${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</small>
            </div>`;
            
            // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ ì´ë™
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    // DOM ìš”ì†Œë¥¼ ì•ˆì „í•˜ê²Œ ì°¸ì¡°
    document.addEventListener('DOMContentLoaded', function() {
        // í¼ submit ë°©ì§€ ë° ë©”ì‹œì§€ ì „ì†¡
        const chatForm = document.getElementById("chat-form");
        if (chatForm) {
            chatForm.addEventListener("submit", sendMessage);
        }
        // Enter í‚¤ë¡œë„ ë©”ì‹œì§€ ì „ì†¡
        const userInput = document.getElementById("user-input");
        if (userInput) {
            userInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
                    sendMessage();
                }
            });
        }

        // ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const sendBtn = document.getElementById("send-btn");
        if (sendBtn) {
            sendBtn.addEventListener("click", sendMessage);
        }
    });
</script>
{% endblock %}