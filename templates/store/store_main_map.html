{% extends 'layout/main/main_base.html' %}
{% load static %}

{% block title %}매장위치{% endblock title %}

{% block header %}
    {% include 'layout/main/main_header.html' %}
{% endblock header %}

{% block content %}
    <style>
        .store-map-container {
            text-align: center;
            margin: 30px auto;
            max-width: 1200px;
            display: flex;
            flex-direction: column;  /* 세로로 배치 */
            justify-content: space-between;  /* 위와 아래에 요소들이 배치되도록 설정 */
            position: relative;  /* 버튼을 내부에서 자유롭게 배치할 수 있게 설정 */
        }
        /* 제목 크기 & 위치 설정 */
        .store-title {
            font-size: 30px;
            font-weight: bold;
            margin-bottom: 30px;
        }
        .store-map-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .map-section {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .store-info-section {
            text-align: left;
        }
        .store-info-section h3 {
            font-size: 20px;
            margin-top: 15px;
            font-weight: bold;
        }
        .store-info-section p {
            font-size: 16px;
            margin: 5px 0;
        }

        /* 수정 버튼을 오른쪽 아래로 배치 */
        .button-container {
            margin-top: 20px;
            align-self: flex-end;
        }
    </style>

<!-- 매장 안내 정보 -->
<div class="store-map-container">
    <h2 class="store-title">매장 위치</h2>
    <div class="store-map-content">
        <div class="map-section">
            <div id="map" style="width: 450px; height: 450px;"></div>
        </div>

        <div class="store-info-section">
            <h3>| 주소</h3>
            <p id="address-display"></p>
            <h3>| 운영 시간</h3>
            <p id="store-time-display"></p>
            <h3>| 매장 전화번호</h3>
            <p id="store-num-display"></p><br><br> 
            <p id="transportation-display"></p>
        </div>
    </div>

    <!-- 매장 변경 버튼 -->
    <div class="button-container">
        <button id="prev-store" class="btn btn-secondary">이전</button>
        <button id="next-store" class="btn btn-secondary">다음</button>
    </div>
</div>

    <!-- 버튼 섹션 -->
    <div class="button-container">
        {% if user.is_authenticated %}
            {% if request.session.member_type == "manager" %}
                <a href="{% url 'store:store_map_edit' %}" class="btn btn-primary">수정</a>
            {% endif %}
        {% endif %}
    </div>

{% endblock content %}

{% block script %}
    {{ block.super }}
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=zsn0ti7kcl&submodules=geocoder"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var stores = JSON.parse('{{ stores|escapejs }}');  // JSON 문자열 파싱
            var storeName = "{{ store_name }}";  // 초기 storeName은 첫 번째 매장 이름
            var currentIndex = 0;
        
            function updateStoreInfo(index) {
                var store = stores[index];
                // 현재 선택된 매장 이름으로 storeName 업데이트
                storeName = store.store_name;
                
                document.getElementById("address-display").innerText = store.store_address;
                document.getElementById("store-time-display").innerText = store.store_time;
                document.getElementById("store-num-display").innerText = store.store_num;
                document.getElementById("transportation-display").innerHTML = store.store_notes;  // HTML 적용
        
                // 지도 업데이트
                updateMap(store.store_address);
            }
        
            function updateMap(address) {
                naver.maps.Service.geocode({query: address}, function(status, response) {
                    if (status !== naver.maps.Service.Status.OK) {
                        return alert('주소를 찾을 수 없습니다!');
                    }
                    var items = response.v2.addresses;
                    var location = new naver.maps.LatLng(items[0].y, items[0].x);
            
                    var map = new naver.maps.Map('map', {
                        center: location,
                        zoom: 16
                    });
            
                    // 매장에 따라 다른 아이콘 사용
                    var iconUrl = "{% static 'images/pink.png' %}";  // 기본 아이콘
                    if (storeName === "강남점") {
                        iconUrl = "{% static 'images/milk.png' %}";
                    }
            
                    var marker = new naver.maps.Marker({
                        position: location,
                        map: map,
                        icon: {
                            url: iconUrl,
                            scaledSize: new naver.maps.Size(60, 60),
                            origin: new naver.maps.Point(0, 0),
                            anchor: new naver.maps.Point(25, 26)
                        }
                    });
            
                    var infowindow = new naver.maps.InfoWindow({
                        content: '<div style="padding:7px;min-width:150px;line-height:100%;"><h5 style="margin-top:3px;">브레드스캔소 ' + storeName + '</h5></div>'
                    });
                    infowindow.open(map, marker);
                });
            }
            // 초기에 첫 번째 매장 정보 표시
            updateStoreInfo(currentIndex);
        
            // 다음 매장 버튼
            document.getElementById("next-store").addEventListener("click", function() {
                currentIndex = (currentIndex + 1) % stores.length;
                updateStoreInfo(currentIndex);
            });
            // 이전 매장 버튼
            document.getElementById("prev-store").addEventListener("click", function() {
                currentIndex = (currentIndex - 1 + stores.length) % stores.length;
                updateStoreInfo(currentIndex);
            });
        });
    </script>

{% endblock script %}

{% block footer %}
    {% include 'layout/main/main_footer.html' %}
{% endblock footer %}

