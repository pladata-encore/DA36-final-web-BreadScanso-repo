{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk | Products</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        .container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            max-width: 1000px;
            margin: auto;
        }

        .video-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        video {
            width: 400px;
            height: 300px;
            border: 2px solid black;
            border-radius: 10px;
        }

        #capture-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background-color: blue;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .order-list {
            width: 350px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .order-list h3 {
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .total {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>

<body class="kiosk-products">
    <!-- í—¤ë” ì¶”ê°€ (ë¡œê³  í¬í•¨) -->
    <header>
        <img src="{% static 'images/brand_logo.png' %}" alt="ë¸Œëœë“œ ë¡œê³ " class="brand-logo">
    </header>

    <!-- ì§€ì ëª… -->
    <div class="store-name">ì„œì´ˆë™ì </div>

    <div class="container">
        <!-- ì™¼ìª½: ì›¹ìº  í™”ë©´ ë° ë²„íŠ¼ -->
        <div class="video-container">
            <video id="webcam" autoplay playsinline></video>
            <button id="capture-btn">ğŸ“¸ì´¬ì˜</button>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì£¼ë¬¸ ëª©ë¡ -->
        <div class="order-list">
            <h3>ë©”ë‰´ ëª©ë¡</h3>
            <table>
                <thead>
                    <tr>
                        <th>ë©”ë‰´ì´ë¦„</th>
                        <th>ë‹¨ê°€</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>ì†Œê¸ˆë¹µ</td><td>3800</td><td>2</td><td>7600</td></tr>
                    <tr><td>ì—ë©˜íƒˆì†Œê¸ˆë¹µ</td><td>4500</td><td>1</td><td>4500</td></tr>
                    <tr><td>ë¹ ë‹¤ì½”ì½”ë„›ê½ˆë² ê¸°</td><td>4500</td><td>1</td><td>4500</td></tr>
                    <tr><td>ë¨¹ë¬¼ì†Œê¸ˆë¹µ</td><td>4200</td><td>1</td><td>4200</td></tr>
                    <tr><td>í›„ì¶”ì†Œê¸ˆë¹µ</td><td>4200</td><td>1</td><td>4200</td></tr>
                </tbody>
            </table>
            <div class="total">
                <p>ì´ ìˆ˜ëŸ‰: <strong>6ê°œ</strong></p>
                <p>ì´ ê¸ˆì•¡: <strong>25,000ì›</strong></p>
            </div>
        </div>
    </div>

    <!-- ë²„íŠ¼ ì˜ì—­ -->
    <div class="button-container">
{#        <button class="yellow-button" id="reset-btn">ë‹¤ì‹œ ìŠ¤ìº”</button>#}
        <button class="blue-button">ì§ì› í˜¸ì¶œ</button>
        <a href="{% url 'member' %}">
            <button class="black-button">ê²°ì œ</button>
        </a>
    </div>




    <!-- JavaScript -->
    <script> // ì£¼ì„ìœ¼ë¡œ localì„œë²„ | ec2ì„œë²„ ì „í™˜
    
// local server
const video = document.getElementById("webcam");
const captureBtn = document.getElementById("capture-btn");
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

const NGROK_URL = "https://5998-175-121-129-72.ngrok-free.app/predict/";

// ğŸ“Œ ì›¹ìº  í™œì„±í™” (ë²„íŠ¼ ëˆ„ë¥´ê¸° ì „ì—ë„ í•­ìƒ í‘œì‹œ)
async function startWebcam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
    } catch (error) {
        console.error("ğŸš¨ ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨:", error);
        alert("ì›¹ìº ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
    }
}

// ğŸ“Œ ìº¡ì²˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
captureBtn.addEventListener("click", async () => {
    captureBtn.disabled = true;  // ë²„íŠ¼ ë¹„í™œì„±í™”
    captureBtn.textContent = "ğŸ”„ ì¶”ë¡  ì¤‘...";

    // ğŸ”¹ ì›¹ìº  í”„ë ˆì„ ìº¡ì²˜
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL("image/jpeg");  // Base64 ì¸ì½”ë”©

    // ğŸ”¹ FastAPI ì¶”ë¡  ì„œë²„ë¡œ ì´ë¯¸ì§€ ì „ì†¡
    try {
        const response = await fetch(NGROK_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({ image: imageData }),
            mode: "cors"
        });

        const result = await response.json();

        // ğŸ“Œ ê²°ê³¼ í™•ì¸
        console.log("ğŸ“· ì¶”ë¡  ê²°ê³¼:", result);

        // ğŸ”¹ JSON ë°ì´í„°ì—ì„œ ìƒí’ˆëª…(name)ê³¼ í™•ë¥ (confidence)ë§Œ ì¶”ì¶œ
        let item_names = [];         // ìƒí’ˆëª… ë¦¬ìŠ¤íŠ¸
        let item_confidences = [];   // í™•ë¥  ë¦¬ìŠ¤íŠ¸

        if (result?.prediction && Array.isArray(result.prediction)) {
            result.prediction.forEach(item => {
                item_names.push(item.name);
                item_confidences.push(item.confidence);
            });

            // âœ… ì½˜ì†” ì¶œë ¥ (ë””ë²„ê¹… ìš©ë„)
            console.log("ğŸ“Œ ìƒí’ˆëª… ë¦¬ìŠ¤íŠ¸:", item_names);
            console.log("ğŸ“Š í™•ë¥  ë¦¬ìŠ¤íŠ¸:", item_confidences);
        } else {
            console.error("âŒ ì˜ˆì¸¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
        }
            alert(item_names[0] + item_confidences[0])

    } catch (error) {
        console.error("ğŸš¨ ì¶”ë¡  ìš”ì²­ ì˜¤ë¥˜:", error);
    } finally {
        captureBtn.disabled = false;  // ë²„íŠ¼ í™œì„±í™”
        captureBtn.textContent = "ğŸ“¸ ì´¬ì˜";
    }
});

// ğŸ“Œ ì›¹ìº  ì‹¤í–‰
startWebcam();


/*
    // ec2
const video = document.getElementById("webcam");
const captureBtn = document.getElementById("capture-btn");
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

const EC2_PREDICT_URL = "http://3.38.150.51:8001/predict/";

// ğŸ“Œ ì›¹ìº  í™œì„±í™”
async function startWebcam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
    } catch (error) {
        console.error("ğŸš¨ ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨:", error);
        alert("ì›¹ìº ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
    }
}

// ğŸ“Œ ìº¡ì²˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
captureBtn.addEventListener("click", async () => {
    captureBtn.disabled = true;
    captureBtn.textContent = "ğŸ”„ ì¶”ë¡  ì¤‘...";

    // ì›¹ìº  ì´ë¯¸ì§€ ìº¡ì²˜
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL("image/jpeg");

    // FastAPIë¡œ ì „ì†¡
    try {
        const response = await fetch(EC2_PREDICT_URL, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({ file: imageData }),
            mode: "cors"
        });

        const result = await response.json();
        console.log("ğŸ“· ì¶”ë¡  ê²°ê³¼:", result);

        if (result?.predictions) {
            alert("âœ… ì¶”ë¡  ì„±ê³µ!\nê²°ê³¼: " + JSON.stringify(result.predictions, null, 2));
        } else {
            alert("âš ï¸ ì¶”ë¡  ì‹¤íŒ¨! ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
        }
    } catch (error) {
        console.error("ğŸš¨ ì¶”ë¡  ìš”ì²­ ì˜¤ë¥˜:", error);
        alert("ğŸš¨ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ!");
    } finally {
        captureBtn.disabled = false;
        captureBtn.textContent = "ğŸ“¸ ì´¬ì˜";
    }
});

// ğŸ“Œ ì›¹ìº  ì‹¤í–‰
startWebcam();
*/
    </script>

    <!-- JavaScript íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° -->
{#    <script src="{% static 'js/kiosk-imageUpload.js' %}"></script>#}

</body>
</html>